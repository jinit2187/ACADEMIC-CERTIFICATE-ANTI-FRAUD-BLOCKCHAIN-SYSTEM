<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>View Certificates</title>

    <link rel="stylesheet" href="/static/vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/vendor/DataTables/css/datatables.min.css">
    <link rel="stylesheet" href="/static/vendor/font-awesome/font-awesome.min.css">
    <link rel="stylesheet" href="/static/css/custom.css">

</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container">
        <a href="#" class="navbar-brand">Blockchain Client</a>

        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a href="/" class="nav-link">Wallet Generator</a>
                </li>
                <li class="nav-item">
                    <a href="/make/transaction" class="nav-link">Issue Certificate</a>
                </li>
                <li class="nav-item active">
                    <a href="/view/transactions" class="nav-link">View Certificates</a>
                </li>
                <li class="nav-item">
                    <a href="/verify/certificate" class="nav-link">Employer Verify</a>
                </li>
                <li class="nav-item">
                    <a href="/student/wallet" class="nav-link">Student Wallet</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
  <div class="row">
    <div class="col-lg-12">

      <div class="card-body">
        <h4 class="card-title">View Certificates</h4>
        <p class="card-text">
            Enter a blockchain node URL and click on "View Certificates" to see all certificates
            stored on that node's chain.
        </p>
      </div>

    </div>
  </div>
</div>

<div class="container alert alert-secondary">

    <div class="row">
      <label class="col-sm-2">Node URL:</label>
      <div class="col-sm-10">
        <textarea id="node_url" rows="1" class="form-control">http://127.0.0.1:5001</textarea>
      </div>
    </div>

    <br>

    <div class="row">
      <div class="col-lg-12 text-center">
        <input type="button" id="view_certificates" class="btn btn-primary btn-lg" value="View Certificates">
      </div>
    </div>

</div>

<br>
<div class="container">
  <table id="certificates_table" class="table table-striped table-bordered" cellspacing="0" width="100%">
  </table>
</div>

<script src="/static/vendor/jquery/jquery.min.js"></script>
<script src="/static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/static/vendor/DataTables/js/datatables.min.js"></script>
<script src="/static/vendor/DataTables/js/ellipsis.js"></script>

<script>
    $(function() {

        $('#view_certificates').click(function(){

          $.ajax({
            url: document.getElementById("node_url").value + "/chain",
            type: 'GET',
            success: function(response){

              var certificates = [];
              var count = 1;

              for (var i = 0; i < response["length"]; i++) {
                for (var j = 0; j < response["chain"][i]["certificates"].length; j++) {

                  var options = {  year: "numeric", month: "short",  day: "numeric",
                                   hour: "2-digit", minute: "2-digit", second: "2-digit"  };
                  var date = new Date(response["chain"][i]["timestamp"] * 1000);
                  var formattedDateTime = date.toLocaleTimeString("en-us", options);
                  var cert = response["chain"][i]["certificates"][j];

                  var row = [
                    count,
                    cert["student_name"],
                    cert["degree"],
                    cert["major"],
                    cert["date_issued"],
                    cert["student_public_key"],
                    cert["university_public_key"],
                    cert["certificate_hash"],
                    formattedDateTime,
                    response["chain"][i]["block_number"]
                  ];
                  certificates.push(row);

                  count += 1;
                }
              }

              $('#certificates_table').dataTable( {
                data: certificates,
                columns: [
                    { title: "#" },
                    { title: "Student Name"},
                    { title: "Degree"},
                    { title: "Major"},
                    { title: "Date Issued"},
                    { title: "Student Public Key"},
                    { title: "University Public Key"},
                    { title: "Certificate Hash"},
                    { title: "Timestamp"},
                    { title: "Block"}
                ],
                columnDefs: [ {targets: [5,6,7,8,9], render: $.fn.dataTable.render.ellipsis(25)}]
              } );

            },
            error: function(error){
              console.log(error);
            }
          });
        });

    });

</script>

</body>
</html>
